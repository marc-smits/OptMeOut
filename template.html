<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{pageTitle}}</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <div class="container mt-5">
    <h1 class="text-center">{{pageTitle}}</h1>
    <div id="form-steps" class="mt-5">
      <!-- Step Navigation -->
      <!--ul class="nav nav-pills mb-4 justify-content-center">
        <li class="nav-item"><a class="nav-link active" href="#step1" data-step="1">Step 1</a></li>
        <li class="nav-item"><a class="nav-link" href="#step2" data-step="2">Step 2</a></li>
        <li class="nav-item"><a class="nav-link" href="#step3" data-step="3">Step 3</a></li>
        <li class="nav-item"><a class="nav-link" href="#step4" data-step="4">Step 4</a></li>
        <li class="nav-item"><a class="nav-link" href="#step5" data-step="5">Step 5</a></li>
        <li class="nav-item"><a class="nav-link" href="#step6" data-step="6">Step 6</a></li>
      </ul-->

      <!-- Form Steps -->
      <div id="step1" class="step-content">
        <div id="step1-form"></div>
      </div>
      <div id="step2" class="step-content d-none">
        <div id="step2-form"></div>
      </div>
      <div id="step3" class="step-content d-none">
        <div id="step3-form"></div>
      </div>
      <div id="step4" class="step-content d-none">
        <div id="step4-form"></div>
      </div>
      <div id="step5" class="step-content d-none">
        <div id="step5-form"></div>
      </div>
      <div id="step6" class="step-content d-none">
        <div id="step6-form"></div>
      </div>

      <!-- Navigation Buttons -->
      <div class="text-center mt-4">
        <button id="prev-step" class="btn btn-secondary" disabled>Previous</button>
        <button id="next-step" class="btn btn-primary">Next</button>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS and Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
  <!-- JSON Editor JS -->
  <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
  <!-- Custom Script -->
  <script type="module">
    const steps = {{steps}};
    const language = {{language}};

    document.addEventListener('DOMContentLoaded', function () {
      const stepLinks = document.querySelectorAll('.nav-link');
      const prevButton = document.getElementById('prev-step');
      const nextButton = document.getElementById('next-step');
      let currentStep = 0;

      // Apply language overrides to steps
      const stepSchemas = Object.keys(steps).map(stepKey => {
        const stepSchema = { ...steps[stepKey] };
        if (language[stepKey]) {
          stepSchema.title = language[stepKey].title || stepSchema.title;
          if (language[stepKey].properties) {
            Object.keys(language[stepKey].properties).forEach(propKey => {
              if (stepSchema.properties[propKey]) {
                stepSchema.properties[propKey] = {
                  ...stepSchema.properties[propKey],
                  ...language[stepKey].properties[propKey]
                };
              }
            });
          }
        }
        return stepSchema;
      });

      
      const stepsContainer = document.querySelectorAll('.step-content');

      // Initialize JSON Editors
      const editors = [];
      stepsContainer.forEach((step, index) => {
        const editor = new JSONEditor(step.querySelector('div'), {
          schema: Object.values(steps)[index],
          theme: 'bootstrap5',
          disable_edit_json: true,
          disable_properties: true,
          disable_collapse: true,
        });
        editors.push(editor);
      });

      // Navigation Logic
      function showStep(stepIndex) {
        stepsContainer.forEach((step, index) => {
          step.classList.toggle('d-none', index !== stepIndex);
        });
        stepLinks.forEach((link, index) => {
          link.classList.toggle('active', index === stepIndex);
        });
        prevButton.disabled = stepIndex === 0;
        nextButton.textContent = stepIndex === stepsContainer.length - 1 ? 'Submit' : 'Next';
        currentStep = stepIndex;
      }

      stepLinks.forEach((link, index) => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          showStep(index);
        });
      });

      prevButton.addEventListener('click', () => {
        if (currentStep > 0) showStep(currentStep - 1);
      });

      nextButton.addEventListener('click', () => {
        if (currentStep < stepsContainer.length - 1) {
          // Validate current step before proceeding
          const errors = editors[currentStep].validate();
          if (errors.length === 0) {
            showStep(currentStep + 1);
          } else {
            alert('Please fix errors before proceeding.');
          }
        } else {
          // Submit Form
          const formData = editors.map(editor => editor.getValue());
          console.log('Form Data:', formData);
          // Send data to API (mock example)
          alert('Je formulier wordt nu afgeleverd.')
          fetch('https://api.example.com/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
          }).then(response => response.json())
            .then(data => alert('Letter submitted successfully!'))
            .catch(error => console.error('Error:', error));
        }
      });

      // Show First Step Initially
      showStep(0);
    });
  </script>
</body>
</html>
